#!/bin/sh

# build_rootfs: installs the RLSD root file system to a directory

. ./config

# include the configuration file
. ./config

# initialize the root file system with the skeleton
cp -ar skeleton "$2"

# remove .gitignore files
find "$2" -name .gitignore -delete

# choose which packages to install
cd flavors
. "./$1"
cd ..

# if all packages were built locally, use the build output
if [ -d repo ]
then
	repo="file://$(pwd)/repo"
else
	# otherwise, use the upstream repository
	repo="http://dimkr.insomnia247.nl/$ARCH"
fi

# install the packages
mkdir -p "$2/var/packdude"
for package in $PACKAGES
do
	packdude -i $package -n -p "$2" -u "$repo"
done

# clean up after packdude
for i in "$2/var/packdude/lock" "$2/var/packdude"/repo-*.sqlite3
do
	rm -vf "$i"
done

# add RLSD's documentation
install -m 644 README "$2/usr/share/doc/rlsd/README"
install -m 644 MANIFEST "$2/usr/share/doc/rlsd/MANIFEST"
install -m 644 AUTHORS "$2/usr/share/doc/rlsd/AUTHORS"
install -m 644 THANKS "$2/usr/share/doc/rlsd/THANKS"
install -m 644 COPYING "$2/usr/share/doc/rlsd/COPYING"

# fix permissions
chown -R 0:0 "$2"
find "$2" -type d | while read directory
do
	chmod 755 "$directory"
done
chmod 700 "$2/home/boss"
chown 1000:1000 "$2/home/someone"
chmod 755 "$2/home/someone"

# rename packdude's installation database; it is copied to the writeable layer
# by rc.initramfs
mv "$2/var/packdude/data.sqlite3" "$2/var/packdude/core.sqlite3"
